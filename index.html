<!DOCTYPE html>
<html>
<head>
    <title>Monitor Familiar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; padding: 20px; background: #000; color: white; font-family: Arial; text-align: center; }
        button { padding: 15px 25px; margin: 10px; border: none; border-radius: 25px; font-size: 18px; background: #4CAF50; color: white; cursor: pointer; }
        button:disabled { background: #666; }
        #status { margin: 15px 0; padding: 10px; border-radius: 8px; font-weight: bold; background: #333; }
        #connectionCode { font-family: monospace; background: #222; padding: 10px; margin: 10px; border-radius: 5px; }
        video { width: 100%; max-width: 400px; border-radius: 10px; border: 3px solid #4CAF50; margin: 15px 0; }
    </style>
</head>
<body>
    <div>
        <h1>üì∑ Monitor Familiar</h1>
        <div id="status">‚ö´ Clique em INICIAR</div>
        
        <button id="startBtn" onclick="startCamera()">üé• INICIAR TRANSMISS√ÉO</button>
        <button id="stopBtn" onclick="stopCamera()" disabled>‚èπÔ∏è PARAR</button>
        
        <div id="connectionInfo" style="display: none;">
            <p>üì± C√≥digo para conectar o app:</p>
            <div id="connectionCode">Gerando c√≥digo...</div>
        </div>
        
        <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <script>
        let localStream = null;
        let peerConnection = null;
        let isTransmitting = false;
        let connectionCode = '';

        async function startCamera() {
            try {
                updateStatus('üü° Iniciando c√¢mera...');
                
                // Obter acesso √† c√¢mera
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 }, 
                    audio: false 
                });

                // Mostrar v√≠deo local
                document.getElementById('localVideo').srcObject = localStream;
                
                // Iniciar conex√£o WebRTC
                await startWebRTC();
                
                updateStatus('üü¢ Aguardando app conectar...');
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('connectionInfo').style.display = 'block';
                
                isTransmitting = true;
                
            } catch (error) {
                updateStatus('üî¥ Erro: ' + error.message);
            }
        }

        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            updateStatus('‚ö´ Transmiss√£o parada');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('connectionInfo').style.display = 'none';
            isTransmitting = false;
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function startWebRTC() {
            // Configura√ß√£o WebRTC (STUN servers gratuitos)
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };

            peerConnection = new RTCPeerConnection(configuration);

            // Adicionar stream da c√¢mera
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Gerar oferta de conex√£o
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            // Criar c√≥digo de conex√£o (base64 da oferta)
            connectionCode = btoa(JSON.stringify(offer));
            document.getElementById('connectionCode').textContent = connectionCode;

            // Esperar por resposta do app
            peerConnection.oniceconnectionstatechange = () => {
                if (peerConnection.iceConnectionState === 'connected') {
                    updateStatus('üü¢ CONECTADO - Transmitindo!');
                } else if (peerConnection.iceConnectionState === 'disconnected') {
                    updateStatus('üü° Conex√£o perdida...');
                }
            };
        }

        // Fun√ß√£o para receber resposta do app (via outro m√©todo)
        window.receiveAnswer = async function(answerBase64) {
            if (!peerConnection) return;
            
            try {
                const answer = JSON.parse(atob(answerBase64));
                await peerConnection.setRemoteDescription(answer);
                updateStatus('üü¢ Conex√£o estabelecida!');
            } catch (error) {
                updateStatus('üî¥ Erro na conex√£o');
            }
        };

        // Iniciar automaticamente
        setTimeout(() => {
            if (!isTransmitting) {
                startCamera();
            }
        }, 1000);
    </script>
</body>
</html>
