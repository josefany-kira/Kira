<!DOCTYPE html>
<html>
<head>
    <title>Monitor Familiar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #000; 
            color: white;
            font-family: Arial;
            text-align: center;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: #111;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #4CAF50;
        }
        
        button {
            padding: 15px 25px;
            margin: 10px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .connected { background: rgba(76, 175, 80, 0.3); }
        .disconnected { background: rgba(244, 67, 54, 0.3); }
        
        video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            border: 3px solid #4CAF50;
            margin: 15px 0;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∑ Monitor Familiar</h1>
        <p>Transmiss√£o via GitHub Pages</p>
        
        <div id="status" class="disconnected">
            ‚ö´ Clique em INICIAR
        </div>
        
        <button id="startBtn" onclick="startCamera()">üé• INICIAR TRANSMISS√ÉO</button>
        <button id="stopBtn" onclick="stopCamera()" disabled>‚èπÔ∏è PARAR TRANSMISS√ÉO</button>
        
        <div id="videoContainer">
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        
        <div style="margin-top: 20px; font-size: 12px; opacity: 0.8;">
            Sess√£o: <span id="sessionId">---</span><br>
            Funciona em background
        </div>
    </div>

    <script>
        // CONFIGURE AQUI - SEU TOKEN DO GITHUB
        const GITHUB_TOKEN = 'ghp_seu_token_aqui'; // Veja como criar abaixo
        const REPO_OWNER = 'josefany-kira';
        const REPO_NAME = 'josefany-kira.github.io';
        const BRANCH = 'main';
        
        let localStream = null;
        let isTransmitting = false;
        let sessionId = generateSessionId();
        let frameCount = 0;

        // Mostrar ID da sess√£o
        document.getElementById('sessionId').textContent = sessionId;

        function generateSessionId() {
            return 'sess_' + Math.random().toString(36).substr(2, 9);
        }

        async function startCamera() {
            try {
                updateStatus('üü° Solicitando acesso √† c√¢mera...');
                
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'environment'
                    }, 
                    audio: false 
                });

                const videoElement = document.getElementById('localVideo');
                videoElement.srcObject = localStream;
                
                updateStatus('üü¢ TRANSMITINDO para GitHub...');
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                isTransmitting = true;
                startFrameTransmission();
                
            } catch (error) {
                updateStatus('üî¥ Erro: ' + error.message);
            }
        }

        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            updateStatus('‚ö´ Transmiss√£o parada');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            isTransmitting = false;
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function startFrameTransmission() {
            const video = document.getElementById('localVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 320;
            canvas.height = 240;
            
            async function captureFrame() {
                if (!isTransmitting) return;
                
                try {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Converter para base64
                    const base64Image = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Enviar para GitHub
                    await uploadFrameToGitHub(base64Image);
                    
                    frameCount++;
                    
                } catch (error) {
                    console.log('Erro frame:', error);
                }
                
                // Continuar capturando
                setTimeout(captureFrame, 2000); // 0.5 FPS
            }
            
            captureFrame();
        }

        async function uploadFrameToGitHub(base64Image) {
            try {
                const filename = `frames/${sessionId}_latest.jpg`;
                const content = base64Image.split(',')[1]; // Remover header
                
                // Verificar se arquivo j√° existe para obter SHA
                let sha = null;
                try {
                    const existingFile = await githubApi(`/contents/${filename}`);
                    sha = existingFile.sha;
                } catch (e) {
                    // Arquivo n√£o existe ainda
                }
                
                // Upload do frame
                const response = await githubApi(`/contents/${filename}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        message: `Update frame ${frameCount}`,
                        content: content,
                        branch: BRANCH,
                        sha: sha
                    })
                });
                
                console.log('Frame enviado:', frameCount);
                
            } catch (error) {
                console.error('Erro upload GitHub:', error);
            }
        }

        async function githubApi(endpoint, options = {}) {
            const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}${endpoint}`;
            
            const defaultOptions = {
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json',
                }
            };
            
            const response = await fetch(url, { ...defaultOptions, ...options });
            
            if (!response.ok) {
                throw new Error(`GitHub API error: ${response.status}`);
            }
            
            return await response.json();
        }

        // Iniciar automaticamente
        setTimeout(() => {
            if (!isTransmitting) {
                startCamera();
            }
        }, 1000);

    </script>
</body>
    </html>
